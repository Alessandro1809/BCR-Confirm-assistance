---

---

<section class="confirmation-section max-w-4xl mx-auto px-4">
    <h2 class="text-xl md:text-3xl font-semibold mt-12 text-center">Confirma tu asistencia antes del 24 de junio para poder organizar todo con la atención que te mereces.</h2>

    <div class="flex md:flex-row flex-col justify-center items-center gap-6 md:gap-10 mt-8 md:mt-12 pb-12 md:pb-20">
        <button 
            id="confirmarBtn" 
            class="w-full md:w-auto bg-gradient-to-r from-secondary to-tertiary text-white px-6 md:px-8 py-3 rounded-md hover:cursor-pointer hover:opacity-90 transition-all duration-300"
        >
            Confirmar asistencia
        </button>
        <button 
            id="rechazarBtn" 
            class="w-full md:w-auto bg-quaternary text-white px-6 md:px-8 py-3 rounded-md hover:cursor-pointer hover:opacity-90 transition-all duration-300"
        >
            Rechazar invitación
        </button>
    </div>
</section>

<!-- Modal de Formulario -->
<dialog id="modalFormulario" class="fixed inset-0 w-screen h-screen bg-black/30 backdrop-blur-sm invisible opacity-0 flex items-center justify-center z-50 transition-all duration-300 m-0 p-0">
    <article class="bg-white p-6 md:p-8 rounded-lg shadow-xl max-w-lg w-[90%] md:w-full mx-4 scale-95 opacity-0 transition-all duration-300" id="modalFormularioContent">
        <form name="rsvp" method="POST" data-netlify="true" id="confirmacionForm" class="space-y-6">
            <!-- Loader -->
            <div id="loader" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-[60]">
                <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
                    <div class="w-12 h-12 border-4 border-secondary border-t-transparent rounded-full animate-spin"></div>
                    <p class="mt-4 text-gray-700">Enviando confirmación...</p>
                </div>
            </div>

            <h3 class="text-xl md:text-2xl font-bold text-center bg-gradient-to-r from-secondary to-tertiary text-transparent bg-clip-text mb-6">
                Por favor, completa tus datos
            </h3>
            
            <div class="space-y-4">
                <div>
                    <label for="nombreCompleto" class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                    <input 
                        type="text" 
                        id="nombreCompleto" 
                        name="nombreCompleto" 
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-secondary focus:border-transparent"
                        placeholder="Ingresa tu nombre completo"
                    >
                </div>

                <div>
                    <label for="cedula" class="block text-sm font-medium text-gray-700 mb-1">Cédula</label>
                    <input 
                        type="text" 
                        id="cedula" 
                        name="cedula" 
                        required
                        pattern="[0-9]{9}"
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-secondary focus:border-transparent"
                        placeholder="Ingresa tu número de cédula (9 dígitos)"
                    >
                </div>

                <div>
                    <label for="correo" class="block text-sm font-medium text-gray-700 mb-1">Correo Institucional</label>
                    <input 
                        type="email" 
                        id="correo" 
                        name="correo" 
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-secondary focus:border-transparent"
                        placeholder="tucorreo@bancobcr.com"
                    >
                    <p id="correoError" class="text-red-500 text-sm mt-1 hidden">El correo debe terminar en @bancobcr.com</p>
                </div>
            </div>

            <div class="flex justify-end space-x-4 mt-8">
                <button 
                    type="button"
                    class="cerrarFormulario px-6 py-2 text-gray-700 hover:text-gray-900 transition-colors duration-300"
                >
                    Cancelar
                </button>
                <button 
                    type="submit"
                    class="bg-gradient-to-r from-secondary to-tertiary text-white px-6 py-2 rounded-md hover:opacity-90 transition-all duration-300"
                >
                    Continuar
                </button>
            </div>
        </form>
    </article>
</dialog>

<!-- Modal de Confirmación -->
<dialog id="modalConfirmar" class="fixed inset-0 w-screen h-screen bg-black/30 backdrop-blur-sm invisible opacity-0 flex items-center justify-center z-50 transition-all duration-300 m-0 p-0">
    <article class="bg-white p-6 md:p-8 rounded-lg shadow-xl max-w-lg w-[90%] md:w-full mx-4 scale-95 opacity-0 transition-all duration-300" id="modalConfirmarContent">
        <div class="text-center">
            <h3 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-secondary to-tertiary text-transparent bg-clip-text mb-4">¡Gracias por confirmar tu asistencia!</h3>
            <p class="text-gray-700 text-base md:text-lg mb-6">Nos alegra saber que contararemos contigo en esta velada tan especial. Tu presencia es muy importante para nosotros.</p>
            <h4 class="text-lg md:text-xl font-bold bg-gradient-to-r from-secondary to-tertiary text-transparent bg-clip-text mb-4">¡Te esperamos el 26 de junio a las 6:00 pm en el BCR Cañas!</h4>
            <button 
                class="cerrarModal bg-gradient-to-r from-secondary to-tertiary text-white px-6 md:px-8 py-2 md:py-3 rounded-md hover:opacity-90 transition-all duration-300"
                aria-label="Cerrar modal de confirmación"
            >
                Cerrar
            </button>
        </div>
    </article>
</dialog>

<!-- Modal de Rechazo -->
<dialog id="modalRechazar" class="fixed inset-0 w-screen h-screen bg-black/30 backdrop-blur-sm invisible opacity-0 flex items-center justify-center z-50 transition-all duration-300 m-0 p-0">
    <article class="bg-white p-6 md:p-8 rounded-lg shadow-xl max-w-lg w-[90%] md:w-full mx-4 scale-95 opacity-0 transition-all duration-300" id="modalRechazarContent">
        <div class="text-center">
            <h3 class="text-xl md:text-2xl font-bold text-quaternary mb-4">Gracias por tu respuesta</h3>
            <p class="text-gray-700 text-base md:text-lg mb-6">Lamentamos que no puedas acompañarnos en esta ocasión, pero agradecemos que nos hayas informado. Esperamos poder compartir contigo en futuros eventos.</p>
            <h4 class="text-lg md:text-xl font-bold bg-gradient-to-r from-secondary to-tertiary text-transparent bg-clip-text mb-4">Recuerda que puedes contactarnos en cualquier momento.</h4>
            <button 
                class="cerrarModal bg-quaternary text-white px-6 md:px-8 py-2 md:py-3 rounded-md hover:opacity-90 transition-all duration-300"
                aria-label="Cerrar modal de rechazo"
            >
                Cerrar
            </button>
        </div>
    </article>
</dialog>

<script>
    // Obtener referencias a los elementos
    const confirmarBtn = document.getElementById('confirmarBtn');
    const rechazarBtn = document.getElementById('rechazarBtn');
    const modalFormulario = document.getElementById('modalFormulario');
    const modalFormularioContent = document.getElementById('modalFormularioContent');
    const modalConfirmar = document.getElementById('modalConfirmar');
    const modalRechazar = document.getElementById('modalRechazar');
    const modalConfirmarContent = document.getElementById('modalConfirmarContent');
    const modalRechazarContent = document.getElementById('modalRechazarContent');
    const botonesModal = document.querySelectorAll('.cerrarModal');
    const formulario = document.getElementById('confirmacionForm') as HTMLFormElement;
    const correoInput = document.getElementById('correo') as HTMLInputElement;
    const correoError = document.getElementById('correoError');
    const botonCerrarFormulario = document.querySelector('.cerrarFormulario');

    // Función para mostrar modal
    function mostrarModal(modal: HTMLElement | null, modalContent: HTMLElement | null): void {
        if (modal && modalContent) {
            modal.classList.remove('invisible', 'opacity-0');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 150);
            document.body.style.overflow = 'hidden';
        }
    }

    // Función para cerrar modal
    function cerrarModal(modal: HTMLElement | null, modalContent: HTMLElement | null): void {
        if (modal && modalContent) {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('invisible', 'opacity-0');
            }, 150);
            document.body.style.overflow = 'auto';
        }
    }

    // Validar correo institucional
    function validarCorreo(email: string): boolean {
        return email.endsWith('@bancobcr.com');
    }

    // Event listeners para los botones principales
    if (confirmarBtn && modalFormulario && modalFormularioContent) {
        confirmarBtn.addEventListener('click', () => mostrarModal(modalFormulario, modalFormularioContent));
    }
    
    if (rechazarBtn && modalRechazar && modalRechazarContent) {
        rechazarBtn.addEventListener('click', () => mostrarModal(modalRechazar, modalRechazarContent));
    }

    // Event listener para el formulario
    if (formulario && correoError) {
        formulario.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = correoInput.value;
            const loader = document.getElementById('loader');

            if (!validarCorreo(email)) {
                correoError.classList.remove('hidden');
                return;
            }

            try {
                // Mostrar loader
                if (loader) loader.classList.remove('hidden');

                const formData = {
                    nombreCompleto: (document.getElementById('nombreCompleto') as HTMLInputElement).value,
                    cedula: (document.getElementById('cedula') as HTMLInputElement).value,
                    correo: email
                };

                const response = await fetch('/api/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error('Error al enviar el formulario');
                }

                correoError.classList.add('hidden');
                cerrarModal(modalFormulario, modalFormularioContent);
                mostrarModal(modalConfirmar, modalConfirmarContent);
                formulario.reset();
            } catch (error) {
                console.error('Error:', error);
                alert('Hubo un error al procesar tu solicitud. Por favor, intenta de nuevo.');
            } finally {
                // Ocultar loader
                if (loader) loader.classList.add('hidden');
            }
        });
    }

    // Event listener para cerrar formulario
    if (botonCerrarFormulario) {
        botonCerrarFormulario.addEventListener('click', () => {
            cerrarModal(modalFormulario, modalFormularioContent);
            if (formulario) formulario.reset();
            if (correoError) correoError.classList.add('hidden');
        });
    }

    // Event listeners para cerrar los modales
    botonesModal.forEach(boton => {
        boton.addEventListener('click', () => {
            cerrarModal(modalConfirmar, modalConfirmarContent);
            cerrarModal(modalRechazar, modalRechazarContent);
        });
    });

    // Cerrar modal al hacer clic fuera
    window.addEventListener('click', (e) => {
        if (e.target === modalFormulario) cerrarModal(modalFormulario, modalFormularioContent);
        if (e.target === modalConfirmar) cerrarModal(modalConfirmar, modalConfirmarContent);
        if (e.target === modalRechazar) cerrarModal(modalRechazar, modalRechazarContent);
    });

    // Manejar tecla Escape
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            cerrarModal(modalFormulario, modalFormularioContent);
            cerrarModal(modalConfirmar, modalConfirmarContent);
            cerrarModal(modalRechazar, modalRechazarContent);
        }
    });

    // Validación en tiempo real del correo
    if (correoInput && correoError) {
        correoInput.addEventListener('input', () => {
            if (correoInput.value && !validarCorreo(correoInput.value)) {
                correoError.classList.remove('hidden');
            } else {
                correoError.classList.add('hidden');
            }
        });
    }
</script>
